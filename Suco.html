<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CinePower — Catálogo</title>
<style>
  :root{
    --bg:#120018;
    --panel:#1b0726;
    --muted:#9b86a6;
    --accent:#9b59b6;
    --card:#20122a;
    --text:#f5eef9;
    --shadow: 0 6px 20px rgba(0,0,0,0.6);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
    background:linear-gradient(180deg,var(--bg),#0a0010);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    min-height:100vh;
  }
  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:18px 22px;
    background:linear-gradient(90deg, rgba(255,255,255,0.02), transparent);
    border-bottom:1px solid rgba(255,255,255,0.03);
    position:sticky; top:0; z-index:40;
  }
  .brand{ display:flex; gap:14px; align-items:center; }
  .logo{
    width:42px; height:42px; border-radius:8px;
    background:linear-gradient(135deg, var(--accent), #6f2fa3);
    display:flex; align-items:center; justify-content:center;
    font-weight:800; color:white; box-shadow:var(--shadow);
  }
  h1{ margin:0; font-size:20px; letter-spacing:1px; color:var(--text) }
  .controls{display:flex; gap:12px; align-items:center}
  .search-wrap{display:flex; gap:10px; align-items:center}
  .search{
    display:flex; align-items:center; gap:8px;
    background:var(--panel); padding:8px 12px; border-radius:999px;
    border:1px solid rgba(255,255,255,0.03);
  }
  .search input{
    background:transparent; border:none; outline:none; color:var(--text);
    width:180px; font-size:15px;
  }
  .btn{
    background:var(--accent); color:white; padding:8px 12px; border-radius:10px;
    border:none; cursor:pointer; font-weight:600; box-shadow:0 6px 16px rgba(155,89,182,0.18);
  }
  .ghost{ background:transparent; border:1px solid rgba(255,255,255,0.05); color:var(--muted) }
  main{ padding:18px; max-width:1200px; margin:0 auto; }
  .catalogo{
    display:grid;
    grid-template-columns: repeat(auto-fill,minmax(170px,1fr));
    gap:14px;
    margin-top:18px;
  }
  .card{
    background:var(--card); border-radius:10px; overflow:hidden; text-align:center;
    box-shadow:var(--shadow); display:flex; flex-direction:column;
    transition:transform .14s ease, box-shadow .14s;
  }
  .card:hover{ transform:translateY(-6px); }
  .thumb{
    width:100%; aspect-ratio: 2/3; object-fit:cover; background:#111; cursor:pointer;
  }
  .title{
    padding:10px; font-weight:700; font-size:14px; letter-spacing:0.6px;
    background:linear-gradient(0deg, rgba(0,0,0,0.12), transparent);
    color:var(--text);
  }
  .card-controls{
    display:flex; gap:8px; padding:10px; justify-content:center;
  }
  .small{ padding:6px 8px; border-radius:8px; font-size:13px; cursor:pointer; border:none }
  .modal{
    position:fixed; inset:0; background:rgba(3,0,6,0.7); display:none;
    align-items:center; justify-content:center; z-index:90;
  }
  .modal.open{ display:flex; }
  .modal-box{
    width:94%; max-width:1000px; background:var(--panel); border-radius:12px; padding:12px;
    box-shadow:0 20px 60px rgba(0,0,0,0.6);
  }
  .modal iframe{ width:100%; height:60vh; border-radius:8px; border:0; background:#000; }
  .admin-panel{
    position:fixed; right:18px; bottom:18px; z-index:60;
  }
  .admin-btn{ background:linear-gradient(180deg,var(--accent),#6f2fa3); color:white; padding:12px 14px; border-radius:12px; border:none; cursor:pointer; box-shadow:0 10px 30px rgba(155,89,182,0.2) }
  .adm-modal{
    position:fixed; right:18px; bottom:80px; width:360px; max-width:94%;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
    border-radius:12px; padding:14px; box-shadow:var(--shadow);
    display:none; z-index:70;
  }
  .adm-modal.open{ display:block; }
  .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
  .field input, .field textarea{ background:var(--panel); border:1px solid rgba(255,255,255,0.03); color:var(--text); padding:8px 10px; border-radius:8px; }
  label{font-size:13px; color:var(--muted) }
  .auth{ max-width:420px; margin:28px auto; background:var(--panel); border-radius:12px; padding:18px; box-shadow:var(--shadow); }
  .auth h2{ text-align:center; margin:6px 0 12px; color:var(--text) }
  .muted{ color:var(--muted); font-size:13px; text-align:center; margin-top:8px }
  .user-badge{ background:rgba(255,255,255,0.03); padding:8px 12px; border-radius:999px; display:flex; gap:10px; align-items:center; color:var(--muted) }
  .pay-badge { background: linear-gradient(90deg,#ff66c4,#8e44ad); color:white; padding:8px 12px; border-radius:999px; font-weight:700; cursor:pointer; border:none }
  @media (max-width:600px){
    .search input{ width:110px }
    .catalogo{ grid-template-columns: repeat(auto-fill,minmax(140px,1fr)) }
  }
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">CP</div>
    <div>
      <h1>CinePower</h1>
      <div style="font-size:12px;color:var(--muted)">Filmes & Player</div>
    </div>
  </div>

  <div class="controls">
    <div class="search-wrap">
      <div class="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="opacity:.9">
          <path d="M21 21l-4.35-4.35" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
          <circle cx="11" cy="11" r="6" stroke="white" stroke-width="1.6"></circle>
        </svg>
        <input id="searchInput" placeholder="Pesquisar filme..." />
      </div>
      <button class="btn ghost" id="sortBtn">Ordenar A-Z</button>
    </div>

    <div id="userArea"></div>
  </div>
</header>

<main>
  <div id="authBox" class="auth" style="display:none">
    <h2>Entrar ou Cadastrar</h2>
    <div class="field">
      <label>Nome de usuário</label>
      <input id="usernameInput" placeholder="ex: João ou email" />
    </div>
    <div class="field">
      <label>Senha (mínimo 6 caracteres)</label>
      <input id="passwordInput" type="password" placeholder="sua senha" />
    </div>
    <div style="display:flex; gap:8px; justify-content:center; margin-top:8px">
      <button class="btn" id="loginBtn">Entrar</button>
      <button class="btn ghost" id="registerBtn">Cadastrar</button>
    </div>
  </div>

  <div id="catalogSection" style="display:none">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px">
      <h2 style="margin:0">Catálogo</h2>
      </div>
    <div class="catalogo" id="catalogo"></div>
  </div>
</main>

<div class="modal" id="playerModal">
  <div class="modal-box">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px;">
      <div id="playerTitle" style="font-weight:700"></div>
      <div style="display:flex; gap:8px">
        <button class="btn ghost" id="closePlayer">Fechar</button>
      </div>
    </div>
    <iframe id="playerFrame" allowfullscreen sandbox="allow-same-origin allow-scripts allow-popups allow-forms"></iframe>
  </div>
</div>

<div class="admin-panel" id="adminPanel" style="display:none">
  <button class="admin-btn" id="openAdmin">Painel ADM</button>
  <div class="adm-modal" id="admModal">
    <h3 style="margin:4px 0 10px">Painel Administrativo</h3>

    <div class="field"><label>Título</label><input id="filmTitle" placeholder="Nome do filme" /></div>
    <div class="field"><label>ID ou Link do Google Drive</label><input id="filmDrive" placeholder="Colar ID ou link (ex: https://drive.google.com/file/d/ABC123/view)" /></div>
    <div class="field"><label>Link da Capa (imagem)</label><input id="filmCover" placeholder="URL da imagem" /></div>
    <div style="display:flex; gap:8px; justify-content:flex-end">
      <button class="btn ghost" id="closeAdmin">Fechar</button>
      <button class="btn" id="addFilmBtn">Adicionar filme</button>
    </div>

    <hr style="border:none; height:1px; background: rgba(255,255,255,0.02); margin:12px 0" />

    <div id="adminList"></div>

  </div>
</div>

<script>
/* Storage keys */
const LS_USERS = 'cine_users_v1';
const LS_FILMS = 'cine_films_v1';
const LS_SESSION = 'cine_session_v1';

/* helpers to load/save */
function loadJSON(key, fallback){ try{ const v = localStorage.getItem(key); return v? JSON.parse(v): fallback; }catch(e){ return fallback; } }
function saveJSON(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }

/* initial admin user */
let users = loadJSON(LS_USERS, null);
if(!users){
  users = [
    { username:'kaicki', password:'123456', role:'admin', createdAt:Date.now(), email:'' }
  ];
  saveJSON(LS_USERS, users);
}
let films = loadJSON(LS_FILMS, []);
let session = loadJSON(LS_SESSION, null);

/* elements */
const authBox = document.getElementById('authBox');
const catalogSection = document.getElementById('catalogSection');
const catalogEl = document.getElementById('catalogo');
const userArea = document.getElementById('userArea');

const usernameInput = document.getElementById('usernameInput');
const passwordInput = document.getElementById('passwordInput');
const loginBtn = document.getElementById('loginBtn');
const registerBtn = document.getElementById('registerBtn');

const playerModal = document.getElementById('playerModal');
const playerFrame = document.getElementById('playerFrame');
const playerTitle = document.getElementById('playerTitle');
const closePlayer = document.getElementById('closePlayer');

const adminPanel = document.getElementById('adminPanel');
const openAdmin = document.getElementById('openAdmin');
const admModal = document.getElementById('admModal');
const closeAdmin = document.getElementById('closeAdmin');
const addFilmBtn = document.getElementById('addFilmBtn');
const filmTitle = document.getElementById('filmTitle');
const filmDrive = document.getElementById('filmDrive');
const filmCover = document.getElementById('filmCover');
const adminList = document.getElementById('adminList');

const searchInput = document.getElementById('searchInput');
const sortBtn = document.getElementById('sortBtn');

let ascending = true;

/* utilities */
function findUserByNameOrEmail(nameOrEmail){
  return users.find(u => u.username.toLowerCase() === nameOrEmail.toLowerCase() || (u.email && u.email.toLowerCase() === nameOrEmail.toLowerCase()));
}
function showToast(msg){ alert(msg); }

/* extract drive ID from multiple patterns */
function extractDriveId(input){
  if(!input) return null;
  if(/^[A-Za-z0-9_-]{10,}$/.test(input)) return input;
  const patterns = [/\/d\/([A-Za-z0-9_-]{10,})/, /id=([A-Za-z0-9_-]{10,})/, /open\?id=([A-Za-z0-9_-]{10,})/];
  for(const p of patterns){ const m = input.match(p); if(m) return m[1]; }
  const maybe = input.match(/([A-Za-z0-9_-]{10,})/);
  return maybe ? maybe[1] : null;
}

/* render catalog */
function renderCatalog(filter=''){
  // if user is not premium and not admin, show message instead of list
  const isPremium = !!localStorage.getItem('cine_premium');
  const isAdmin = session && session.role === 'admin';

  catalogEl.innerHTML = '';

  if(!isPremium && !isAdmin){
    // show call-to-action to subscribe
    catalogEl.innerHTML = `<div style="grid-column:1/-1;color:var(--muted);text-align:center;padding:40px 0">
      <div style="font-size:18px;margin-bottom:8px">Acesso restrito</div>
      <div style="color:var(--muted);margin-bottom:12px">Assine Premium por R$5/mês para ver o catálogo</div>
      <button id="subscribeNow" class="pay-badge">💜 Assinar R$5</button>
    </div>`;
    document.getElementById('subscribeNow').addEventListener('click', ()=> createPreferenceAndRedirect());
    return;
  }

  const list = films
    .filter(f => f.title.toLowerCase().includes(filter.toLowerCase()))
    .sort((a,b)=> ascending? a.title.localeCompare(b.title) : b.title.localeCompare(a.title));
  if(list.length===0){
    catalogEl.innerHTML = '<div style="grid-column:1/-1;color:var(--muted);text-align:center;padding:40px 0">Nenhum filme encontrado</div>';
    return;
  }
  list.forEach((f, idx) => {
    const card = document.createElement('div');
    card.className = 'card';
    // clicking image opens player; do not expose raw links
    card.innerHTML = `
      <img class="thumb" src="${escapeHtml(f.cover||'')}" alt="${escapeHtml(f.title)}" onerror="this.src='https://via.placeholder.com/400x600/21102a/9b59b6?text=SEM+CAPA'" onclick="openPlayerByIndex(${idx})"/>
      <div class="title">${escapeHtml(f.title)}</div>
      <div class="card-controls">
        <button class="small" data-idx="${idx}" onclick="openPlayerByIndex(${idx})" style="background:linear-gradient(180deg,var(--accent),#6f2fa3);color:#fff">▶ Assistir</button>
      </div>
    `;
    catalogEl.appendChild(card);
  });
  window.openPlayerByIndex = idx => openPlayer(films[idx]);
}

/* render admin list (edit/remove) */
function renderAdminList(){
  adminList.innerHTML = '';
  if(films.length===0){ adminList.innerHTML = '<div style="color:var(--muted)">Nenhum filme cadastrado</div>'; return; }
  const ul = document.createElement('div');
  ul.style.display='flex'; ul.style.flexDirection='column'; ul.style.gap='8px';
  films.forEach((f,i)=>{
    const row = document.createElement('div');
    row.style.display='flex'; row.style.alignItems='center'; row.style.justifyContent='space-between';
    row.style.gap='8px';
    row.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><img src="${escapeHtml(f.cover||'')}" style="width:48px;height:72px;object-fit:cover;border-radius:6px" onerror="this.src='https://via.placeholder.com/80x120/21102a/9b59b6?text=SEM'"/><div style="font-weight:700">${escapeHtml(f.title)}</div></div>
      <div style="display:flex;gap:8px">
        <button class="small ghost" onclick="editFilm(${i})">Editar</button>
        <button class="small" onclick="removeFilm(${i})" style="background:#881d6b">Remover</button>
      </div>`;
    ul.appendChild(row);
  });
  adminList.appendChild(ul);

  window.removeFilm = idx => {
    if(!confirm('Remover filme?')) return;
    films.splice(idx,1); saveJSON(LS_FILMS, films); renderCatalog(searchInput.value); renderAdminList();
  }
  window.editFilm = idx => {
    const f = films[idx];
    filmTitle.value = f.title;
    filmDrive.value = f.driveRaw || '';
    filmCover.value = f.cover || '';
    if(confirm('Salvará por cima? OK para remover e editar (faça as alterações e clique Adicionar)')){
      films.splice(idx,1); saveJSON(LS_FILMS, films);
      renderCatalog(searchInput.value); renderAdminList();
    }
  }
}

/* player open/close (modal) */
function openPlayer(f){
  const id = f.driveId;
  if(!id){ showToast('Filme sem ID válido'); return; }
  const url = `https://drive.google.com/file/d/${id}/preview`;
  playerFrame.src = url;
  playerTitle.textContent = f.title;
  playerModal.classList.add('open');
}
closePlayer.addEventListener('click', ()=> { playerFrame.src=''; playerModal.classList.remove('open'); });
playerModal.addEventListener('click', (e)=>{ if(e.target === playerModal){ playerFrame.src=''; playerModal.classList.remove('open'); } });

/* auth */
function showAuth(show){ authBox.style.display = show ? 'block' : 'none'; catalogSection.style.display = show ? 'none' : 'block'; }
function updateUserArea(){
  if(session){
    userArea.innerHTML = `<div class="user-badge"><div style="font-weight:700">${escapeHtml(session.username)}</div>
      <div style="font-size:13px;color:var(--muted)">${escapeHtml(session.role||'user')}</div>
      <button class="btn ghost" id="logoutBtn">Sair</button>
    </div>`;
    document.getElementById('logoutBtn').addEventListener('click', ()=> {
      session = null; localStorage.removeItem(LS_SESSION); refreshUI();
    });
    if(session.role === 'admin') adminPanel.style.display = 'block'; else adminPanel.style.display = 'none';
  }else{
    userArea.innerHTML = '';
    adminPanel.style.display = 'none';
  }
}

/* login/register handlers */
loginBtn.addEventListener('click', ()=>{
  const name = (usernameInput.value||'').trim();
  const pass = (passwordInput.value||'').trim();
  if(!name || !pass){ showToast('Preencha usuário e senha'); return; }
  const u = findUserByNameOrEmail(name);
  if(!u){ showToast('Usuário não encontrado'); return; }
  if(u.password !== pass){ showToast('Senha incorreta'); return; }
  session = { username: u.username, role: u.role||'user' };
  saveJSON(LS_SESSION, session);
  refreshUI();
});

registerBtn.addEventListener('click', ()=>{
  const name = (usernameInput.value||'').trim();
  const pass = (passwordInput.value||'').trim();
  if(!name || !pass){ showToast('Preencha usuário e senha'); return; }
  if(pass.length < 6){ showToast('Senha precisa ter ao menos 6 caracteres'); return; }
  if(findUserByNameOrEmail(name)){ showToast('Usuário já existe'); return; }
  users.push({ username: name, password: pass, role: 'user', createdAt: Date.now(), email: '' });
  saveJSON(LS_USERS, users);
  showToast('Conta criada. Agora faça o login.');
});

/* admin adding films */
addFilmBtn.addEventListener('click', ()=>{
  const title = (filmTitle.value||'').trim();
  const driveRaw = (filmDrive.value||'').trim();
  const cover = (filmCover.value||'').trim();
  if(!title){ showToast('Informe o título'); return; }
  if(!driveRaw){ showToast('Informe o ID ou link do Google Drive'); return; }
  const id = extractDriveId(driveRaw);
  if(!id){ showToast('Não foi possível extrair o ID do Google Drive'); return; }
  const newFilm = { title, driveId: id, driveRaw, cover, createdAt: Date.now() };
  films.unshift(newFilm); saveJSON(LS_FILMS, films);
  filmTitle.value = ''; filmDrive.value=''; filmCover.value='';
  renderCatalog(searchInput.value); renderAdminList();
  showToast('Filme adicionado com sucesso');
});

/* search & sort */
searchInput.addEventListener('input', ()=> renderCatalog(searchInput.value));
sortBtn.addEventListener('click', ()=>{ ascending = !ascending; sortBtn.textContent = ascending ? 'Ordenar A-Z' : 'Ordenar Z-A'; renderCatalog(searchInput.value); });

/* admin UI toggles */
openAdmin.addEventListener('click', ()=> { admModal.classList.toggle('open'); renderAdminList(); });
closeAdmin.addEventListener('click', ()=> admModal.classList.remove('open'));

/* escape */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

/* ===========================
   Mercado Pago integration (frontend)
   - This calls your backend endpoint which creates a MP preference
   - Replace BACKEND_URL with your deployed backend (Render/Railway/Replit)
   =========================== */

const BACKEND_URL = "https://REPLACE_WITH_YOUR_BACKEND/create_preference"; // <<-- coloque aqui a URL do seu backend

async function createPreferenceAndRedirect(){
  try {
    if(!BACKEND_URL || BACKEND_URL.includes("REPLACE_WITH_YOUR_BACKEND")){
      alert("Backend não configurado. Configure BACKEND_URL no código com a URL do seu servidor.");
      return;
    }
    // optional: pass user info to backend (session)
    const resp = await fetch(BACKEND_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ reason: "Powercine - Assinatura R$5", amount: 5.00 })
    });
    const data = await resp.json();
    if(resp.ok && data.init_point){
      // abre o checkout do Mercado Pago
      window.location.href = data.init_point;
    } else {
      console.error(data);
      alert("Erro ao iniciar checkout. Veja console.");
    }
  } catch(err){
    console.error(err);
    alert("Erro de conexão com o backend.");
  }
}

/* ===========================
   Initial render & session handling
   =========================== */
function refreshUI(){
  const sess = loadJSON(LS_SESSION, null);
  session = sess;
  if(session){
    showAuth(false);
    updateUserArea();
    renderCatalog('');
  }else{
    showAuth(true);
    updateUserArea();
  }
}
refreshUI();
renderCatalog('');
renderAdminList();
passwordInput.addEventListener('keypress', (e)=>{ if(e.key === 'Enter') loginBtn.click(); });

/* expose debug (optional) */
window._cine = { users, films, session, saveJSON, loadJSON };
</script>
</body>
</html>
